<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="ActivityDAO">
 	
 	<resultMap type="com.actibuddy.activity.model.dto.LocationDTO" id="locationResultMap">
 	   <id property="code" column="LOCATION_CODE"/>
 	   <result property="name" column="LOCATION_NAME"/>
 	   <result property="info" column="LOCATION_INFO"/>
 	   <result property="image" column="LOCATION_IMG"/>
 	   <result property="tip" column="GUIDE_TIP"/>
 	   <result property="visitMonth" column="VISIT_MONTH"/>
 	   <result property="visitName" column="VISIT_NAME"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.LocationAndActivityDTO" id="locationAndActivityResultMap">
 	   <id property="code" column="LOCATION_CODE"/>
 	   <result property="name" column="LOCATION_NAME"/>
 	   <result property="info" column="LOCATION_INFO"/>
 	   <result property="image" column="LOCATION_IMG"/>
 	   <result property="tip" column="GUIDE_TIP"/>
 	   <result property="visitMonth" column="VISIT_MONTH"/>
 	   <result property="visitName" column="VISIT_NAME"/>
 	   <collection property="activityList" resultMap="activityAndReviewMap"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityDTO" id="activityResultMap">
 	   <id property="code" column="ACTI_NUM"/>
 	   <result property="name" column="ACTI_NAME"/>
 	   <result property="location" column="LOCATION"/>
 	   <result property="price" column="PRICE"/>
 	   <result property="StartDate" column="START_DATE"/>
 	   <result property="EndDate" column="END_DATE"/>
 	   <result property="tip" column="ACTI_TIP"/>
 	   <result property="image" column="ACTI_IMG"/>
 	   <result property="loactionCode" column="LOCATION_CODE"/>
 	   <result property="activitTypeCode" column="ACTI_TYPE_NUM"/>
 	   <result property="userId" column="USER_ID"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActiReviewDTO" id="reviewResultMap">
 	<id property="num" column="ACTI_REVIEW_NUM"/>
 	<result property="writeDate" column="ACTI_REVIEW_DATE"/>
 	<result property="actiNum" column="ACTI_NUM"/>
 	<result property="writerId" column="WRITER_ID"/>
 	<result property="title" column="ACTI_REVIEW_TITLE"/>
 	<result property="content" column="ACTI_REVIEW_CON"/>
 	<result property="reviewStar" column="ACTI_REVIEW_STAR"/>
 	<result property="image" column="ACTI_REVIEW_IMG"/>
 	<result property="recommend" column="ACTI_REVIEW_REC"/>
 	<result property="recYn" column="ACTI_REVIEW_REP_YN"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityAndReviewDTO" id="activityAndReviewMap">
 	<id property="code" column="ACTI_NUM"/>
 	   <result property="name" column="ACTI_NAME"/>
 	   <result property="location" column="LOCATION"/>
 	   <result property="price" column="PRICE"/>
 	   <result property="StartDate" column="START_DATE"/>
 	   <result property="EndDate" column="END_DATE"/>
 	   <result property="tip" column="ACTI_TIP"/>
 	   <result property="image" column="ACTI_IMG"/>
 	   <result property="loactionCode" column="LOCATION_CODE"/>
 	   <result property="activitTypeCode" column="ACTI_TYPE_NUM"/>
 	   <result property="userId" column="USER_ID"/>
 	   <result property="avgStar" column="AVG"/>
 	   <result property="count" column="COUNT"/>
 	  <collection property="reviewList" resultMap="reviewResultMap"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityConditionDTO" id="conditionResultMap">
 	<id property="actiConNum" column="ACTI_CON_NUM"/>
 	<result property="conName" column="ACTI_CON_NAME"/>
 	<result property="conIcon" column="ACTI_CON_ICON"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityTypeDTO" id="typeResultMap">
 	<id property="actiTypeNum" column="ACTI_TYPE_NUM"/>
 	<result property="firstTypeNum" column="FIRST_TYPE_NUM"/>
 	<result property="firstTypeName" column="FIRST_TYPE_NAME"/>
 	<result property="secondTypeNum" column="SECOND_TYPE_NUM"/>
 	<result property="secondTypeName" column="SECOND_TYPE_NAME"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityOptionDTO" id="optionResultMap">
 	<id property="optionNum" column="OPTION_NUM"/>
 	<result property="price" column="OPTION_PRICE"/>
 	<result property="optionName" column="OPTION_NAME"/>
 	<result property="actiNum" column="ACTI_NUM"/>
 	</resultMap>
 	
 	<resultMap type="com.actibuddy.activity.model.dto.ActivityInfoDTO" id="activityInfoResultMap">
    <result property="avgStar" column="AVG"/>
 	<result property="count" column="COUNT"/>
 	<collection property="activityList" resultMap="activityResultMap"/>
 	<collection property="reviewList" resultMap="reviewResultMap"/>
 	<collection property="conditionList" resultMap="conditionResultMap"/>
 	<collection property="typeList" resultMap="typeResultMap"/>
 	<collection property="optionList" resultMap="optionResultMap"/>
 	<collection property="locationList" resultMap="locationResultMap"/>
 	</resultMap>
 	
 	
 	
 	
 	
 	
 	
 	<select id="selectLocationInfo" resultMap="locationAndActivityResultMap" parameterType="hashMap">
	 	SELECT
	      	  A.*
            , B.*
            , C.*
	  	  FROM LOCATION A
	      LEFT JOIN ACTIVITY_INFO B ON (A.LOCATION_CODE = B.LOCATION_CODE)
	      LEFT JOIN ACTI_REVIEW C ON (B.ACTI_NUM = C.ACTI_NUM)
	     WHERE A.LOCATION_NAME = #{ locationName, jdbcType=VARCHAR }
	      <where>
	     	<if test="date != null">
	     		B.START_DATE > #{ date }
	     	</if>
	     	<if test="price1 != null">
	     		B.PRICE BETWEEN #{ price1 } AND #{ price2 }
	     	</if>
	     	
	     	<if test="sort != null and sort == 'star'">
	   			EXISTS (SELECT ROUND(AVG(C.ACTI_REVIEW_STAR),1)
	                      FROM ACTI_REVIEW C
	                      JOIN ACTIVITY_INFO B ON (C.ACTI_NUM = B.ACTI_NUM)
	                   )
				   ORDER BY ACTI_REVIEW_STAR DESC
	     	</if>
	     </where>
	       <if test="sort != null and sort == 'popular'">
	       	 	ORDER BY C.ACTI_REVIEW_REC
	       </if>
	       <if test="sort != null and sort == 'price'">
	       	 	ORDER BY B.PRICE ASC
	       </if>
	       <if test="sort != null and sort == 'new'">
	       	 	ORDER BY B.START_DATE DESC
	       </if>
	       ORDER BY 1
 	</select>
 	
 	<select id="selectActivityInfo" resultMap="activityInfoResultMap" parameterType="String">
 	    SELECT
               A.*
             , C.*
             , D.*
             , E.*
             , F.*
             , G.*
             , (SELECT ROUND(AVG(C.ACTI_REVIEW_STAR),1)
                  FROM ACTI_REVIEW C
                  JOIN ACTIVITY_INFO B ON (C.ACTI_NUM = B.ACTI_NUM)
                 WHERE B.ACTI_NAME = #{ actiName })AS AVG
             , (SELECT COUNT(C.ACTI_REVIEW_TITLE)
                  FROM ACTI_REVIEW C
      	          JOIN ACTIVITY_INFO B ON (C.ACTI_NUM = B.ACTI_NUM)
                 WHERE B.ACTI_NAME = #{ actiName })AS COUNT    
        FROM ACTIVITY_INFO A
        LEFT JOIN ACTI_CONDITION_HIS B ON (A.ACTI_NUM = B.ACTI_NUM)
        LEFT JOIN ACTI_CONDITION C ON (B.ACTI_CON_NUM = C.ACTI_CON_NUM)
        LEFT JOIN ACTI_REVIEW D ON (A.ACTI_NUM = D.ACTI_NUM)
        LEFT JOIN ACTI_TYPE E ON ( A.ACTI_TYPE_NUM = E.ACTI_TYPE_NUM)
        LEFT JOIN ACTI_OPTION F ON (A.ACTI_NUM = F.ACTI_NUM)
        LEFT JOIN LOCATION G ON (A.LOCATION_CODE = G.LOCATION_CODE)
       WHERE A.ACTI_NAME = #{ actiName }
 	</select>
 	
 	<select id="selectLocation" resultMap="locationResultMap">
 		SELECT
      		   A.LOCATION_NAME
             , A.LOCATION_INFO
     		 , A.LOCATION_IMG
  		  FROM LOCATION A
 	</select>
 	
 	
 	<select id="selectActivityByPrice" resultMap="locationAndActivityResultMap" parameterType="hashMap">
 	
 		SELECT
       		   A.LOCATION_NAME
     		 , A.LOCATION_INFO
     	 	 , A.LOCATION_IMG
     		 , A.GUIDE_TIP
     		 , B.ACTI_NUM
     		 , B.ACTI_NAME
     		 , B.LOCATION
     		 , B.PRICE
     		 , B.START_DATE
     		 , B.END_DATE
     		 , B.ACTI_TIP
     		 , B.ACTI_IMG
     		 , B.LOCATION_CODE
     		 , B.ACTI_TYPE_NUM
     		 , B.USER_ID                                                                   
  		  FROM LOCATION A
  		  JOIN ACTIVITY_INFO B ON (A.LOCATION_CODE = B.LOCATION_CODE)
 		 WHERE A.LOCATION_NAME = '서울'
   		   AND B.PRICE BETWEEN #{ prices1, jdbcType=VARCHAR } AND #{ prices2, jdbcType=VARCHAR  }
   		 ORDER BY B.PRICE ASC
 	
 	</select>
 	
 	<select id="selectRecommendActivity" resultMap="activityResultMap" parameterType="String">
 	
 	    SELECT 
               ROWNUM
             , V2.*
          FROM (SELECT V.*  
                  FROM (SELECT A.*
                  FROM ACTIVITY_INFO A
                  LEFT JOIN LOCATION B ON (A.LOCATION_CODE = B.LOCATION_CODE)
                 WHERE A.LOCATION_CODE = (SELECT LOCATION_CODE
                                            FROM ACTIVITY_INFO A
                                           WHERE ACTI_NAME = #{ actiName }
                                         ) 
                   AND A.ACTI_NAME <![CDATA[ <> ]]> #{ actiName }                      
                 ORDER BY DBMS_RANDOM.RANDOM
                ) V
        WHERE ROWNUM <![CDATA[ < ]]> 4) V2
 	
 	</select>
 
 </mapper>